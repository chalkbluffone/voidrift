---
applyTo: "globals/**"
---

# Progression & Upgrades — Voidrift Domain

## XP Curve (Player Leveling)

Uses polynomial formula for predictable, tunable progression:

```
threshold(level) = Σ XP_BASE * n^XP_EXPONENT  for n = 1 to level-1
```

**Constants:** `XP_BASE` (first level cost), `XP_EXPONENT` (curve steepness)

```gdscript
## Cumulative XP threshold to reach a given level.
func _xp_threshold(level: int) -> float:
    if level <= 1:
        return 0.0
    var total: float = 0.0
    for n: int in range(1, level):
        total += GameConfig.XP_BASE * pow(float(n), GameConfig.XP_EXPONENT)
    return total
```

## Static XP Drops

XP drops are **not scaled** by time or difficulty:

```gdscript
enemy.xp_value = GameConfig.ENEMY_XP_ELITE if is_elite else GameConfig.ENEMY_XP_NORMAL
```

**Constants:** `ENEMY_XP_NORMAL = 1.0`, `ENEMY_XP_ELITE = 3.0`

## Difficulty Stat

Player stat (0.0 = 0%, 1.0 = 100%) that multiplicatively scales enemy effectiveness:

```gdscript
var diff_hp_mult: float = 1.0 + (difficulty_stat * GameConfig.DIFFICULTY_HP_WEIGHT)
var diff_damage_mult: float = 1.0 + (difficulty_stat * GameConfig.DIFFICULTY_DAMAGE_WEIGHT)
var final_hp_mult: float = time_hp_mult * diff_hp_mult
var final_damage_mult: float = time_damage_mult * diff_damage_mult
```

Also affects spawn rate in `_get_spawn_interval()` via `DIFFICULTY_SPAWN_WEIGHT`.

## Rarity System

Five tiers: Common → Uncommon → Rare → Epic → Legendary

- `RARITY_ORDER` defines the tier sequence
- `RARITY_DEFAULT_WEIGHTS` controls base drop/roll probabilities
- Player's `luck` stat influences rarity rolls
- Used by: weapon upgrades, station buffs, level-up options

## Level-Up Options

On level up, player chooses 1 of `LEVEL_UP_OPTION_COUNT` (default 3) upgrade options:

- `UpgradeService.generate_level_up_options()` rolls rarity, picks stats
- `OFFER_WEIGHT_*` constants control weapon vs module frequency
- `MAX_WEAPON_SLOTS` and `MAX_MODULE_SLOTS` limit loadout size

## Station Buffs

Generated by `StationService` when a station charge completes:

- 3 buff options per station (matching level-up UI pattern)
- Rarity: Uncommon–Legendary, influenced by player's `luck` stat
- `STATION_RARITY_WEIGHTS`, `STATION_BUFF_RANGES`, `STATION_BUFFABLE_STATS`
- **Flat stat scaling**: flat stats (shield, max_hp) are scaled ×100 at generation in `StationService._generate_single_buff` so stored amount matches applied value

## Credits

- `CREDIT_DROP_CHANCE` — Base chance for credit drop on enemy kill
- `CREDIT_SCALE_PER_MINUTE` — Credit value scaling over run time

## Run Structure

- Timed survival, default 10 min (`GameConfig.DEFAULT_RUN_DURATION`)
- Swarm events at 4 min and 7 min (see `enemies.instructions.md`)
- Final boss via beacon mechanic (not yet implemented)
- Run tracking includes `swarms_completed` count
